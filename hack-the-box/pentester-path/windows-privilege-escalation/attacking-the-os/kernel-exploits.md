# Kernel Exploits

It's a big challenge to ensure that all user desktops and servers are updated, and 100% compliance for all computers with security patches is likely not an achievable goal. Assuming a computer has been targeted for installation of updates, for example, using SCCM (Microsoft System Center Configuration Manager) or WSUS (Windows Server Update Services), there are still many reasons they could fail to install. Over the years, there have been many kernel exploits that affect the Windows operating system from Windows 2000/XP up to Windows 10/Server 2016/2019. Below can be found a detailed table of known remote code execution/local privilege escalation exploits for Windows operating systems, broken down by service pack level, from Windows XP onward to Server 2016.

| Base OS                                | XP  |     |     |     | 2003 |     |     | Vista |     |     | 2008 |     | 7   |     | 2008R2 |     | 8 | 8.1 | 2012 | 2012R2 | 10 | 2016 |
| -------------------------------------- | --- | --- | --- | --- | ---- | --- | --- | ----- | --- | --- | ---- | --- | --- | --- | ------ | --- | - | --- | ---- | ------ | -- | ---- |
| Service Pack                           | SP0 | SP1 | SP2 | SP3 | SP0  | SP1 | SP2 | SP0   | SP1 | SP2 | SP0  | SP2 | SP0 | SP1 | SP0    | SP1 |   |     |      |        |    |      |
| MS03-026                               | •   | •   | •   | •   | •    | •   | •   |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS05-039                               | •   | •   | •   |     | •    | •   |     |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS08-025                               | •   | •   | •   |     | •    | •   | •   | •     | •   |     | •    |     |     |     |        |     |   |     |      |        |    |      |
| MS08-067                               | •   | •   | •   | •   | •    | •   | •   | •     | •   |     | •    |     |     |     |        |     |   |     |      |        |    |      |
| MS08-068                               | •   | •   | •   | •   | •    | •   | •   | •     | •   |     | •    |     |     |     |        |     |   |     |      |        |    |      |
| MS09-012                               | •   | •   | •   | •   | •    | •   | •   | •     | •   |     | •    |     |     |     |        |     |   |     |      |        |    |      |
| MS09-050                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   |     |     |        |     |   |     |      |        |    |      |
| MS10-015                               |     |     | •   | •   | •    | •   | •   | •     | •   | •   |      |     |     |     |        |     |   |     |      |        |    |      |
| MS10-059                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   |     | •      |     |   |     |      |        |    |      |
| MS10-092                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   |     | •      |     |   |     |      |        |    |      |
| MS11-011                               |     |     |     | •   | •    | •   | •   | •     | •   | •   | •    | •   | •   |     | •      |     |   |     |      |        |    |      |
| MS11-046                               |     |     |     | •   | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   |   |     |      |        |    |      |
| MS11-062                               |     |     |     | •   | •    | •   | •   |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS11-080                               |     |     |     | •   | •    | •   | •   |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS13-005                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   | • |     | •    |        |    |      |
| MS13-053                               |     |     |     | •   | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • |     | •    |        |    |      |
| MS13-081                               |     |     | •   | •   | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • |     | •    |        |    |      |
| MS14-002                               |     |     |     | •   | •    | •   | •   |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS14-040                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS14-058                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS14-062                               |     |     |     |     | •    | •   | •   |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS14-068                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS14-070                               |     |     |     |     | •    | •   | •   |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS15-001                               |     |     |     |     |      |     |     |       |     |     |      |     | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS15-010                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS15-051                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS15-061                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS15-076                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS15-078                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS15-097                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      | •  |      |
| MS16-016                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   |   |     |      |        |    |      |
| MS16-032                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   |   | •   | •    | •      |    |      |
| MS16-135                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   |   | •   | •    | •      | •  | •    |
| MS17-010                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      | •  | •    |
| CVE-2017-0213: COM Aggregate Marshaler |     |     |     |     |      |     |     |       |     |     |      |     | •   | •   | •      | •   | • | •   | •    | •      | •  | •    |
| Hot Potato                             |     |     |     |     |      |     |     |       |     |     |      |     | •   | •   | •      | •   | • | •   | •    | •      | •  |      |
| SmashedPotato                          |     |     |     |     |      |     |     |       |     |     |      |     | •   | •   | •      | •   | • | •   | •    | •      | •  |      |

{% hint style="info" %}
**Note:** This table is not 100% complete, and does not go past 2017. As of today, there are more known vulnerabilities for the newer operating system versions and even Server 2019.
{% endhint %}

This [site](https://msrc.microsoft.com/update-guide/vulnerability) is handy for searching out detailed information about Microsoft security vulnerabilities. This database has 4,733 security vulnerabilities entered at the time of writing, showing the massive attack surface that a Windows environment presents.

As we can see from this table, there are many exploits that work for Windows XP up through Server 2012R2. As we get to Windows 10 and Server 2016, there are fewer known exploits. This is partly due to changes to the operating system over time, including security improvements and deprecation of older versions of protocols such as SMB. One important thing to note from this table is that when new vulnerabilities are discovered or exploits released (such as MS17-010), these usually trickle down and affect prior operating system versions. This is why it is vital to stay on top of patching or upgrading, retiring, or segregating off Windows systems that have reached end of life. We will explore this in more depth later on in this module.

It is important to note that while some of the examples above `are` remote code execution vulnerabilities, we can just as easily use them to escalate privileges. One example is if we gain access to a system and notice a port such as 445 (SMB service) not accessible from the outside, we may be able to privilege escalate if it is vulnerable to something such as EternalBlue (MS17-010). In this case, we could either port forward the port in question to be accessible from our attack host or run the exploit in question locally to escalate privileges.

***

## Notable Vulnerabilities

Over the years, there have been many high-impact Windows vulnerabilities that can be leveraged to escalate privileges, some being purely local privilege escalation vectors and others being remote code execution (RCE) flaws that can be used to escalate privileges by forwarding a local port. One example of the latter would be landing on a box that does not allow access to port 445 from the outside, performing port forward to access this port from our attack box, and leveraging a remote code execution flaw against the SMB service to escalate privileges. Below are some extremely high-impact Windows vulnerabilities over the years that can be leveraged to escalate privileges.

`MS08-067` - This was a remote code execution vulnerability in the "Server" service due to improper handling of RPC requests. This affected Windows Server 2000, 2003, and 2008 and Windows XP and Vista and allows an unauthenticated attacker to execute arbitrary code with SYSTEM privileges. Though typically encountered in client environments as a remote code execution vulnerability, we may land on a host where the SMB service is blocked via the firewall. We can use this to escalate privileges after forwarding port 445 back to our attack box. Though this is a "legacy" vulnerability, I still do see this pop up from time to time in large organizations, especially those in the medical industry who may be running specific applications that only work on older versions of Windows Server/Desktop. We should not discount older vulnerabilities even in 2021. We will run into every scenario under the sun while performing client assessments and must be ready to account for all possibilities. The box [Legacy](https://0xdf.gitlab.io/2019/02/21/htb-legacy.html) on the Hack The Box platform showcases this vulnerability from the remote code execution standpoint. There are standalone as well as a Metasploit version of this exploit.

`MS17-010` - Also known as [EternalBlue](https://en.wikipedia.org/wiki/EternalBlue) is a remote code execution vulnerability that was part of the FuzzBunch toolkit released in the [Shadow Brokers](https://en.wikipedia.org/wiki/The_Shadow_Brokers) leak. This exploit leverages a vulnerability in the SMB protocol because the SMBv1 protocol mishandles packets specially crafted by an attacker, leading to arbitrary code execution on the target host as the SYSTEM account. As with MS08-067, this vulnerability can also be leveraged as a local privilege escalation vector if we land on a host where port 445 is firewalled off. There are various versions of this exploit for the Metasploit Framework as well as standalone exploit scripts. This attack was showcased in the [Blue](https://0xdf.gitlab.io/2021/05/11/htb-blue.html) box on Hack The Box, again from the remote standpoint.

`ALPC Task Scheduler 0-Day` - The ALPC endpoint method used by the Windows Task Scheduler service could be used to write arbitrary DACLs to `.job` files located in the `C:\Windows\tasks` directory. An attacker could leverage this to create a hard link to a file that the attacker controls. The exploit for this flaw used the [SchRpcSetSecurity](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-tsch/a8172c11-a24a-4ad9-abd0-82bcf29d794d?redirectedfrom=MSDN) API function to call a print job using the XPS printer and hijack the DLL as NT AUTHORITY\SYSTEM via the Spooler service. An in-depth writeup is available [here](https://blog.grimm-co.com/2020/05/alpc-task-scheduler-0-day.html). The Hack The Box box [Hackback](https://snowscan.io/htb-writeup-hackback/) can be used to try out this privilege escalation exploit.

Summer of 2021 revealed a treasure trove of new Windows and Active Directory-related remote code execution and local privilege escalation flaws to the delight of penetration testers (and real-world attackers), and I'm sure groans from our hard-working colleagues on the defense side of things.

`CVE-2021-36934 HiveNightmare, aka SeriousSam` is a Windows 10 flaw that results in ANY user having rights to read the Windows registry and access sensitive information regardless of privilege level. Researchers quickly developed a PoC exploit to allow reading of the SAM, SYSTEM, and SECURITY registry hives and create copies of them to process offline later and extract password hashes (including local admin) using a tool such as SecretsDump.py. More information about this flaw can be found [here](https://doublepulsar.com/hivenightmare-aka-serioussam-anybody-can-read-the-registry-in-windows-10-7a871c465fa5) and [this](https://github.com/GossiTheDog/HiveNightmare/raw/master/Release/HiveNightmare.exe) exploit binary can be used to create copies of the three files to our working directory. This [script](https://github.com/GossiTheDog/HiveNightmare/blob/master/Mitigation.ps1) can be used to detect the flaw and also fix the ACL issue. Let's take a look.

