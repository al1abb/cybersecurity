# Passwd, Shadow & Opasswd. Linux Authentication Process

Linux-based distributions can use many different authentication mechanisms. One of the most commonly used and standard mechanisms is [Pluggable Authentication Modules](https://web.archive.org/web/20220622215926/http://www.linux-pam.org/Linux-PAM-html/Linux-PAM_SAG.html) (`PAM`). The modules used for this are called `pam_unix.so` or `pam_unix2.so` and are located in `/usr/lib/x86_x64-linux-gnu/security/` in Debian based distributions. These modules manage user information, authentication, sessions, current passwords, and old passwords. For example, if we want to change the password of our account on the Linux system with `passwd`, PAM is called, which takes the appropriate precautions and stores and handles the information accordingly.

The `pam_unix.so` standard module for management uses standardized API calls from the system libraries and files to update the account information. The standard files that are read, managed, and updated are `/etc/passwd` and `/etc/shadow`. PAM also has many other service modules, such as LDAP, mount, or Kerberos.

## Passwd File

The `/etc/passwd` file contains information about every existing user on the system and can be read by all users and services. Each entry in the `/etc/passwd` file identifies a user on the system. Each entry has seven fields containing a form of a database with information about the particular user, where a colon (`:`) separates the information. Accordingly, such an entry may look something like this:

```shell-session
htb-student:x:1000:1000:,,,:/home/htb-student:/bin/bash
```

| Field                                              | Value               |
| -------------------------------------------------- | ------------------- |
| Username                                           | `htb-student`       |
| Password                                           | `x`                 |
| User ID                                            | `1000`              |
| Group ID                                           | `1000`              |
| [GECOS](https://en.wikipedia.org/wiki/Gecos_field) | `,,,`               |
| Home directory                                     | `/home/htb-student` |
| Default shell                                      | `/bin/bash`         |

The most relevant field for our purposes is the `Password` field, as it can contain different types of entries. In rare cases (generally on very old systems) this field may hold the actual password hash. On modern systems, however, password hashes are stored in the `/etc/shadow` file, which we'll examine later. Despite this, the `/etc/passwd` file is world-readable, giving attackers the ability to crack the passwords if hashes are stored here.

Usually, we will find the value `x` in this field, indicating that the passwords are stored in a hashed form within the `/etc/shadow` file. However, it can also be that the `/etc/passwd` file is writeable by mistake. This would allow us to remove the password field for the `root` user entirely.

```shell-session
$ head -n 1 /etc/passwd

root::0:0:root:/root:/bin/bash
```

This results in no password prompt being displayed when attempting to log in as `root`.

```shell-session
$ su

root@htb[/htb]#
```

Although the scenarios described are rare, we should still pay attention and watch for potential security gaps, as there are applications that require specific permissions fon entire folders. If the administrator has little experience with Linux (or the applications and their dependencies), they might mistakenly assign write permissions to the `/etc` directory and fail to correct them later.

## Shadow file

Since reading password hash values can put the entire system at risk, the `/etc/shadow` file was introduced. It has a similar format to `/etc/passwd` but is solely responsible for password storage and management. It contains all password information for created users. For example, if there is no entry in the `/etc/shadow` file for a user listed in `/etc/passwd`, that user is considered invalid. The `/etc/shadow` file is also only readable by users with administrative privileges. The format of this file is divided into the following `nine fields`:

```shell-session
htb-student:$y$j9T$3QSBB6CbHEu...SNIP...f8Ms:18955:0:99999:7:::
```

<table><thead><tr><th width="191.272705078125">Field</th><th>Value</th></tr></thead><tbody><tr><td>Username</td><td><code>htb-student</code></td></tr><tr><td>Password</td><td><code>$y$j9T$3QSBB6CbHEu...SNIP...f8Ms</code></td></tr><tr><td>Last change</td><td><code>18955</code></td></tr><tr><td>Min age</td><td><code>0</code></td></tr><tr><td>Max age</td><td><code>99999</code></td></tr><tr><td>Warning period</td><td><code>7</code></td></tr><tr><td>Inactivity period</td><td><code>-</code></td></tr><tr><td>Expiration date</td><td><code>-</code></td></tr><tr><td>Reserved field</td><td><code>-</code></td></tr></tbody></table>

If the `Password` field contains a character such as `!` or `*`, the user cannot log in using a Unix password. However, other authentication methods—such as Kerberos or key-based authentication—can still be used. The same applies if the `Password` field is empty, meaning no password is required for login. This can lead to certain programs denying access to specific functions. The `Password` field also follows a particular format, from which we can extract additional information:

* `$<id>$<salt>$<hashed>`

As we can see here, the hashed passwords are divided into three parts. The `ID` value specifies which cryptographic hash algorithm was used, typically one of the following:

<table><thead><tr><th width="93.09088134765625">ID</th><th>Cryptographic Hash Algorithm</th></tr></thead><tbody><tr><td><code>1</code></td><td><a href="https://en.wikipedia.org/wiki/MD5">MD5</a></td></tr><tr><td><code>2a</code></td><td><a href="https://en.wikipedia.org/wiki/Blowfish_(cipher)">Blowfish</a></td></tr><tr><td><code>5</code></td><td><a href="https://en.wikipedia.org/wiki/SHA-2">SHA-256</a></td></tr><tr><td><code>6</code></td><td><a href="https://en.wikipedia.org/wiki/SHA-2">SHA-512</a></td></tr><tr><td><code>sha1</code></td><td><a href="https://en.wikipedia.org/wiki/SHA-1">SHA1crypt</a></td></tr><tr><td><code>y</code></td><td><a href="https://github.com/openwall/yescrypt">Yescrypt</a></td></tr><tr><td><code>gy</code></td><td><a href="https://www.openwall.com/lists/yescrypt/2019/06/30/1">Gost-yescrypt</a></td></tr><tr><td><code>7</code></td><td><a href="https://en.wikipedia.org/wiki/Scrypt">Scrypt</a></td></tr></tbody></table>

Many Linux distributions, including Debian, now use `yescrypt` as the default hashing algorithm. On older systems, however, we may still encounter other hashing methods that can potentially be cracked. We'll discuss how the cracking process works shortly.

## Opasswd

The PAM library (`pam_unix.so`) can prevent users from reusing old passwords. These previous passwords are stored in the `/etc/security/opasswd` file. Administrator (root) privileges are required to read this file, assuming its permissions have not been modified manually.

```shell-session
$ sudo cat /etc/security/opasswd

cry0l1t3:1000:2:$1$HjFAfYTG$qNDkF0zJ3v8ylCOrKB0kt0,$1$kcUjWZJX$E9uMSmiQeRh4pAAgzuvkq1
```

Looking at the contents of this file, we can see that it contains several entries for the user `cry0l1t3`, separated by a comma (`,`). One critical detail to pay attention to is the type of hash that's been used. This is because the `MD5` (`$1$`) algorithm is significantly easier to crack than SHA-512. This is particularly important when identifying old passwords and recognizing patterns, as users often reuse similar passwords across multiple services or applications. Recognizing these patterns can greatly improve our chances of correctly guessing the password.

## Cracking Linux Credentials

Once we have root access on a Linux machine, we can gather user password hashes and attempt to crack them using various methods to recover the plaintext passwords. To do this, we can use a tool called [unshadow](https://github.com/pmittaldev/john-the-ripper/blob/master/src/unshadow.c), which is included with John the Ripper (JtR). It works by combining the `passwd` and `shadow` files into a single file suitable for cracking.

```shell-session
al1abb@htb[/htb]$ sudo cp /etc/passwd /tmp/passwd.bak 
al1abb@htb[/htb]$ sudo cp /etc/shadow /tmp/shadow.bak 
al1abb@htb[/htb]$ unshadow /tmp/passwd.bak /tmp/shadow.bak > /tmp/unshadowed.hashes
```

This "unshadowed" file can now be attacked with either JtR or hashcat.

```shell-session
$ hashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked
```

{% hint style="info" %}
**Note:** This is the exact scenario that JtR's `single crack mode` was designed for.
{% endhint %}

## Further reading

For further reading on the Linux authentication process, this [document](https://tldp.org/HOWTO/pdf/User-Authentication-HOWTO.pdf) by [The Linux Documentation Project](https://tldp.org/) is a great reference.
