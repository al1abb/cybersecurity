# Attacking LDAP

`LDAP` (Lightweight Directory Access Protocol) is `a protocol` used to `access and manage directory information`. A `directory` is a `hierarchical data store` that contains information about network resources such as `users`, `groups`, `computers`, `printers`, and other devices. LDAP provides some excellent functionality:

<table data-header-hidden><thead><tr><th width="187.6363525390625"></th><th></th></tr></thead><tbody><tr><td><strong>Functionality</strong></td><td><strong>Description</strong></td></tr><tr><td><code>Efficient</code></td><td>Efficient and fast queries and connections to directory services, thanks to its lean query language and non-normalised data storage.</td></tr><tr><td><code>Global naming model</code></td><td>Supports multiple independent directories with a global naming model that ensures unique entries.</td></tr><tr><td><code>Extensible and flexible</code></td><td>This helps to meet future and local requirements by allowing custom attributes and schemas.</td></tr><tr><td><code>Compatibility</code></td><td>It is compatible with many software products and platforms as it runs over TCP/IP and SSL directly, and it is <code>platform-independent</code>, suitable for use in heterogeneous environments with various operating systems.</td></tr><tr><td><code>Authentication</code></td><td>It provides <code>authentication</code> mechanisms that enable users to <code>sign on once</code> and access multiple resources on the server securely.</td></tr></tbody></table>

However, it also suffers some significant issues:

<table><thead><tr><th width="117.6363525390625">Functionality</th><th>Description</th></tr></thead><tbody><tr><td><code>Compliance</code></td><td>Directory servers <code>must be LDAP compliant</code> for service to be deployed, which may <code>limit the choice</code> of vendors and products.</td></tr><tr><td><code>Complexity</code></td><td><code>Difficult to use and understand</code> for many developers and administrators, who may not know how to configure LDAP clients correctly or use it securely.</td></tr><tr><td><code>Encryption</code></td><td>LDAP <code>does not encrypt its traffic by default</code>, which exposes sensitive data to potential eavesdropping and tampering. LDAPS (LDAP over SSL) or StartTLS must be used to enable encryption.</td></tr><tr><td><code>Injection</code></td><td><code>Vulnerable to LDAP injection attacks</code>, where malicious users can manipulate LDAP queries and <code>gain unauthorised access</code> to data or resources. To prevent such attacks, input validation and output encoding must be implemented.</td></tr></tbody></table>

LDAP is `commonly used` for providing a `central location` for `accessing` and `managing` directory services. Directory services are collections of information about the organisation, its users, and assetsâ€“like usernames and passwords. LDAP enables organisations to store, manage, and secure this information in a standardised way. Here are some common use cases:

<table data-header-hidden><thead><tr><th width="183.0909423828125"></th><th></th></tr></thead><tbody><tr><td><strong>Use Case</strong></td><td><strong>Description</strong></td></tr><tr><td><code>Authentication</code></td><td>LDAP can be used for <code>central authentication</code>, allowing users to have single login credentials across multiple applications and systems. This is one of the most common use cases for LDAP.</td></tr><tr><td><code>Authorisation</code></td><td>LDAP can <code>manage permissions</code> and <code>access control</code> for network resources such as folders or files on a network share. However, this may require additional configuration or integration with protocols like Kerberos.</td></tr><tr><td><code>Directory Services</code></td><td>LDAP provides a way to <code>search</code>, <code>retrieve</code>, and <code>modify data</code> stored in a directory, making it helpful for managing large numbers of users and devices in a corporate network. <code>LDAP is based on the X.500 standard</code> for directory services.</td></tr><tr><td><code>Synchronisation</code></td><td>LDAP can be used to <code>keep data consistent</code> across multiple systems by <code>replicating changes</code> made in one directory to another.</td></tr></tbody></table>

There are two popular implementations of LDAP: `OpenLDAP`, an open-source software widely used and supported, and `Microsoft Active Directory`, a Windows-based implementation that seamlessly integrates with other Microsoft products and services.

Although LDAP and AD are `related`, they `serve different purposes`. `LDAP` is a `protocol` that specifies the method of accessing and modifying directory services, whereas `AD` is a `directory service` that stores and manages user and computer data. While LDAP can communicate with AD and other directory services, it is not a directory service itself. AD offers extra functionalities such as policy administration, single sign-on, and integration with various Microsoft products.

| **LDAP**                                                                                                                                   | **Active Directory (AD)**                                                                                                                                                                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| A `protocol` that defines how clients and servers communicate with each other to access and manipulate data stored in a directory service. | A `directory server` that uses LDAP as one of its protocols to provide authentication, authorisation, and other services for Windows-based networks.                                                         |
| An `open and cross-platform protocol` that can be used with different types of directory servers and applications.                         | `Proprietary software` that only works with Windows-based systems and requires additional components such as DNS (Domain Name System) and Kerberos for its functionality.                                    |
| It has a `flexible and extensible schema` that allows custom attributes and object classes to be defined by administrators or developers.  | It has a `predefined schema` that follows and extends the X.500 standard with additional object classes and attributes specific to Windows environments. Modifications should be made with caution and care. |
| Supports `multiple authentication mechanisms` such as simple bind, SASL, etc.                                                              | It supports `Kerberos` as its primary authentication mechanism but also supports NTLM (NT LAN Manager) and LDAP over SSL/TLS for backward compatibility.                                                     |

LDAP works by using a `client-server architecture`. A client sends an LDAP request to a server, which searches the directory service and returns a response to the client. LDAP is a protocol that is simpler and more efficient than X.500, on which it is based. It uses a client-server model, where clients send requests to servers using LDAP messages encoded in ASN.1 (Abstract Syntax Notation One) and transmitted over TCP/IP (Transmission Control Protocol/Internet Protocol). The servers process the requests and send back responses using the same format. LDAP supports various requests, such as `bind`, `unbind`, `search`, `compare`, `add`, `delete`, `modify`, etc.

`LDAP requests` are `messages` that clients send to servers to `perform operations` on data stored in a directory service. An LDAP request is comprised of several components:

1. `Session connection`: The client connects to the server via an LDAP port (usually 389 or 636).
2. `Request type`: The client specifies the operation it wants to perform, such as `bind`, `search`, etc.
3. `Request parameters`: The client provides additional information for the request, such as the `distinguished name` (DN) of the entry to be accessed or modified, the scope and filter of the search query, the attributes and values to be added or changed, etc.
4. `Request ID`: The client assigns a unique identifier for each request to match it with the corresponding response from the server.

Once the server receives the request, it processes it and sends back a response message that includes several components:

1. `Response type`: The server indicates the operation that was performed in response to the request.
2. `Result code`: The server indicates whether or not the operation was successful and why.
3. `Matched DN:` If applicable, the server returns the DN of the closest existing entry that matches the request.
4. `Referral`: The server returns a URL of another server that may have more information about the request, if applicable.
5. `Response data`: The server returns any additional data related to the response, such as the attributes and values of an entry that was searched or modified.

After receiving and processing the response, the client disconnects from the LDAP port.

### **ldapsearch**

For example, `ldapsearch` is a command-line utility used to search for information stored in a directory using the LDAP protocol. It is commonly used to query and retrieve data from an LDAP directory service.

```shell-session
$ ldapsearch -H ldap://ldap.example.com:389 -D "cn=admin,dc=example,dc=com" -w secret123 -b "ou=people,dc=example,dc=com" "(mail=john.doe@example.com)"
```

This command can be broken down as follows:

* Connect to the server `ldap.example.com` on port `389`.
* Bind (authenticate) as `cn=admin,dc=example,dc=com` with password `secret123`.
* Search under the base DN `ou=people,dc=example,dc=com`.
* Use the filter `(mail=john.doe@example.com)` to find entries that have this email address.

The server would process the request and send back a response, which might look something like this:

```ldap
dn: uid=jdoe,ou=people,dc=example,dc=com
objectClass: inetOrgPerson
objectClass: organizationalPerson
objectClass: person
objectClass: top
cn: John Doe
sn: Doe
uid: jdoe
mail: john.doe@example.com

result: 0 Success
```

This response includes the entry's `distinguished name (DN)` that matches the search criteria and its attributes and values.

***

## LDAP Injection

`LDAP injection` is an attack that `exploits web applications that use LDAP` (Lightweight Directory Access Protocol) for authentication or storing user information. The attacker can `inject malicious code` or `characters` into LDAP queries to alter the application's behaviour, `bypass security measures`, and `access sensitive data` stored in the LDAP directory.

To test for LDAP injection, you can use input values that contain `special characters or operators` that can change the query's meaning:

